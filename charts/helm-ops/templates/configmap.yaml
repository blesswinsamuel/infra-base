{{- $extraArgs := "" -}}
{{- range .Values.helmExtraValuesFiles -}}
{{- $extraArgs = cat $extraArgs (printf "--values $HELM_CHART_DIR/%s" .) -}}
{{- end -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: '{{ include "helm-ops.fullname" . }}'
data:
  hooks.yaml: |
    - id: redeploy-webhook
      execute-command: "/config/redeploy.sh"
      command-working-directory: "/config"
  redeploy.sh: |
    #!/bin/bash
    set -ex

    HELM_CHART_DIR=$GIT_REPO_PATH/{{ .Values.helmChartPath }}

    {{- .Values.scripts.predeploy | nindent 4 }}

    helm -n {{ .Values.helmReleaseNamespace }} diff upgrade {{ .Values.helmReleaseName }} {{ $extraArgs }} $HELM_CHART_DIR --three-way-merge
    helm -n {{ .Values.helmReleaseNamespace }} upgrade --install {{ .Values.helmReleaseName }} {{ $extraArgs }} $HELM_CHART_DIR
